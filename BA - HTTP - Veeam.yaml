zabbix_export:
  version: '7.4'
  template_groups:
    - uuid: 8fdb1680986b48c781ac1ea2a485a917
      name: BA/HTTP
  templates:
    - uuid: 96d88b30329a4c36b6d42b341295e558
      template: 'BA - HTTP - Veeam'
      name: 'BA - HTTP - Veeam'
      vendor:
        name: 'below average'
        version: 0.0.0.0
      groups:
        - name: BA/HTTP
      items:
        - uuid: 9ae4e0df868a44f88026330676fc4974
          name: 'Veeam Jobs Discovery'
          type: SCRIPT
          key: veeam.jobs
          delay: 5m
          history: '0'
          value_type: TEXT
          params: |
            var obj = JSON.parse(value);
            var url = obj.url;
            var api = obj.api;
            var user = "{$VEEAM_USER}";
            var pass = "{$VEEAM_PASS}";
            var request = new HttpRequest();
            request.addHeader("x-api-version: 1.1-rev0");
            request.addHeader("accept: application/json");
            var token = JSON.parse(request.post(url + "oauth2/token", "grant_type=password&username=" + user + "&password=" + pass)).access_token;
            request.addHeader("Authorization: Bearer " + token);
            return request.get(url + api);
          timeout: 3s
          parameters:
            - name: api
              value: v1/jobs/states
            - name: url
              value: 'https://{HOST.HOST}:9419/api/'
          tags:
            - tag: 'Item Type'
              value: Discovery
        - uuid: 831492be81dd4b849cd77348b3edd618
          name: 'Veeam Version'
          type: SCRIPT
          key: veeam.version
          delay: 12h
          history: 30d
          value_type: TEXT
          params: |
            var obj = JSON.parse(value);
            var url = obj.url;
            var api = obj.api;
            var user = "{$VEEAM_USER}";
            var pass = "{$VEEAM_PASS}";
            var request = new HttpRequest();
            request.addHeader("x-api-version: 1.1-rev0");
            request.addHeader("accept: application/json");
            var token = JSON.parse(request.post(url + "oauth2/token", "grant_type=password&username=" + user + "&password=" + pass)).access_token;
            request.addHeader("Authorization: Bearer " + token);
            return request.get(url + api);
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.buildVersion
          timeout: 3s
          parameters:
            - name: api
              value: v1/serverInfo
            - name: url
              value: 'https://{HOST.HOST}:9419/api/'
          tags:
            - tag: 'Item Type'
              value: Version
      discovery_rules:
        - uuid: 5b80dbbc2f564807be78cbc079cdcdd8
          name: 'Veeam Jobs Discovery'
          type: DEPENDENT
          key: veeam.jobs.discovery
          lifetime: 30d
          enabled_lifetime_type: DISABLE_NEVER
          item_prototypes:
            - uuid: 1fc5becbc7b345f99d43676d3d62faf1
              name: 'Veeam Job ({#NAME}) Last Result'
              type: DEPENDENT
              key: 'veeam.jobs.lastresult[{#NAME}]'
              history: 90d
              value_type: CHAR
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.data.[?(@.name=="{#NAME}")].lastResult.first()'
              master_item:
                key: veeam.jobs
              tags:
                - tag: 'Item Type'
                  value: Status
                - tag: Job
                  value: '{#NAME}'
              trigger_prototypes:
                - uuid: 5737da01e3e34a1ebeb05a2dac82d549
                  expression: 'last(/BA - HTTP - Veeam/veeam.jobs.lastresult[{#NAME}])<>"Success" and last(/BA - HTTP - Veeam/veeam.jobs.lastresult[{#NAME}])<>"None"'
                  name: 'Veeam Job ({#NAME}) Last Result != Success'
                  priority: HIGH
                  description: 'The last run of this job was not successful.'
                  manual_close: 'YES'
                  tags:
                    - tag: 'Trigger Type'
                      value: State
            - uuid: 77ef2a4ddcfe4854895283fe5ce21e10
              name: 'Veeam Job ({#NAME}) Last Run'
              type: DEPENDENT
              key: 'veeam.jobs.lastrun[{#NAME}]'
              history: 7d
              value_type: CHAR
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.data.[?(@.name=="{#NAME}")].lastRun.first()'
              master_item:
                key: veeam.jobs
              tags:
                - tag: 'Item Type'
                  value: Date
                - tag: Job
                  value: '{#NAME}'
            - uuid: 827c77eb38914b65b311f3c3c859a390
              name: 'Veeam Job ({#NAME}) Next Run'
              type: DEPENDENT
              key: 'veeam.jobs.nextrun[{#NAME}]'
              history: 7d
              value_type: CHAR
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.data.[?(@.name=="{#NAME}")].nextRun.first()'
              master_item:
                key: veeam.jobs
              tags:
                - tag: 'Item Type'
                  value: Date
                - tag: Job
                  value: '{#NAME}'
            - uuid: feda128672764e18b1a627a0fafb4e73
              name: 'Veeam Job ({#NAME}) Status'
              type: DEPENDENT
              key: 'veeam.jobs.status[{#NAME}]'
              history: 90d
              value_type: CHAR
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.data.[?(@.name=="{#NAME}")].status.first()'
              master_item:
                key: veeam.jobs
              tags:
                - tag: 'Item Type'
                  value: Status
                - tag: Job
                  value: '{#NAME}'
            - uuid: 4b20b0db8a4d40928192d18ab673daec
              name: 'Veeam Job ({#NAME}) Type'
              type: DEPENDENT
              key: 'veeam.jobs.type[{#NAME}]'
              history: 7d
              value_type: CHAR
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.data.[?(@.name=="{#NAME}")].type.first()'
              master_item:
                key: veeam.jobs
              tags:
                - tag: 'Item Type'
                  value: Type
                - tag: Job
                  value: '{#NAME}'
            - uuid: 752c067975ca4b639b1becbbcd31a5e8
              name: 'Veeam Job ({#NAME}) Workload'
              type: DEPENDENT
              key: 'veeam.jobs.workload[{#NAME}]'
              history: 7d
              value_type: CHAR
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.data.[?(@.name=="{#NAME}")].workload.first()'
              master_item:
                key: veeam.jobs
              tags:
                - tag: 'Item Type'
                  value: Type
                - tag: Job
                  value: '{#NAME}'
          master_item:
            key: veeam.jobs
          lld_macro_paths:
            - lld_macro: '{#NAME}'
              path: $.name
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.data
      tags:
        - tag: Agent
          value: HTTP
        - tag: 'Template Type'
          value: Poller


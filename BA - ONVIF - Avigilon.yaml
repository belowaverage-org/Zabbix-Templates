zabbix_export:
  version: '7.4'
  template_groups:
    - uuid: 709a337c872146989712a383cb393fa8
      name: BA/ONVIF
  templates:
    - uuid: c6bf4572df0a4cc28ced8aed23cec940
      template: 'BA - ONVIF - Avigilon'
      name: 'BA - ONVIF - Avigilon'
      vendor:
        name: 'below average'
        version: 0.0.0.0
      groups:
        - name: BA/ONVIF
      items:
        - uuid: 9c5b4a272bb44a8983ff14bda4c749aa
          name: 'Device Firmware Version'
          type: DEPENDENT
          key: camera.firmware.version
          history: 7d
          value_type: CHAR
          inventory_link: OS
          preprocessing:
            - type: REGEX
              parameters:
                - 'onvif://www.onvif.org/avigilon/firmware/version/(.*?)"'
                - \1
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1d
          master_item:
            key: camera.scopes
          tags:
            - tag: Type
              value: Firmware
        - uuid: 62c9ab8714064b7f91eddae1ca247b10
          name: 'Device Info'
          type: HTTP_AGENT
          key: camera.info
          delay: 1h
          history: 3h
          value_type: TEXT
          preprocessing:
            - type: XML_TO_JSON
          timeout: 30s
          url: '{$ONVIF_SHIM_URL}/{HOST.CONN}'
          query_fields:
            - name: user
              value: '{$AVIG_CAM_USERNAME}'
            - name: pass
              value: '{$AVIG_CAM_PASSWORD}'
          posts: '<soap:Envelope xmlns:soap="http://www.w3.org/2003/05/soap-envelope" xmlns:tds="http://www.onvif.org/ver10/device/wsdl" xmlns:tt="http://www.onvif.org/ver10/schema"><soap:Body><tds:GetDeviceInformation /></soap:Body></soap:Envelope>'
          request_method: POST
          tags:
            - tag: Type
              value: ONVIF
        - uuid: a901ebe015ec41578b6f7265970a7efd
          name: 'Device Media'
          type: HTTP_AGENT
          key: camera.media
          delay: 1h
          history: 3h
          value_type: TEXT
          preprocessing:
            - type: XML_TO_JSON
          timeout: 30s
          url: '{$ONVIF_SHIM_URL}/{HOST.CONN}'
          query_fields:
            - name: user
              value: '{$AVIG_CAM_USERNAME}'
            - name: pass
              value: '{$AVIG_CAM_PASSWORD}'
            - name: path
              value: /onvif/media_service
          posts: '<soap:Envelope xmlns:soap="http://www.w3.org/2003/05/soap-envelope" xmlns:trt="http://www.onvif.org/ver10/media/wsdl" xmlns:tt="http://www.onvif.org/ver10/schema"><soap:Body><trt:GetVideoSources /></soap:Body></soap:Envelope>'
          request_method: POST
          tags:
            - tag: Type
              value: ONVIF
        - uuid: cd309dfaf45646d681098c866f2ac499
          name: 'Device Model'
          type: DEPENDENT
          key: camera.model
          history: 7d
          value_type: CHAR
          inventory_link: MODEL
          preprocessing:
            - type: REGEX
              parameters:
                - 'onvif://www.onvif.org/hardware/(.*?)"'
                - \1
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1d
          master_item:
            key: camera.scopes
          tags:
            - tag: Type
              value: Model
        - uuid: cbb50b55e58e43799b3619025ea4a604
          name: 'Device Name'
          type: DEPENDENT
          key: camera.name
          history: 7d
          value_type: CHAR
          inventory_link: NAME
          preprocessing:
            - type: REGEX
              parameters:
                - 'onvif://www.onvif.org/name/(.*?)"'
                - \1
            - type: STR_REPLACE
              parameters:
                - acc/
                - ''
            - type: STR_REPLACE
              parameters:
                - '%20'
                - ' '
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1d
          master_item:
            key: camera.scopes
          tags:
            - tag: Type
              value: Name
        - uuid: c569bead71ff46c9990ec6ca6ee6238b
          name: 'Device MAC'
          type: DEPENDENT
          key: camera.net.mac
          history: 7d
          value_type: CHAR
          inventory_link: MACADDRESS_A
          preprocessing:
            - type: REGEX
              parameters:
                - 'onvif://www.onvif.org/avigilon/mac/(.{17})'
                - \1
            - type: STR_REPLACE
              parameters:
                - '-'
                - ':'
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1d
          master_item:
            key: camera.scopes
          tags:
            - tag: Type
              value: MAC
        - uuid: 87a53d70753c474bbb21303663af837f
          name: 'Device Scopes'
          type: HTTP_AGENT
          key: camera.scopes
          delay: 15m
          history: 1h
          value_type: TEXT
          preprocessing:
            - type: XML_TO_JSON
          timeout: 30s
          url: '{$ONVIF_SHIM_URL}/{HOST.CONN}'
          query_fields:
            - name: user
              value: '{$AVIG_CAM_USERNAME}'
            - name: pass
              value: '{$AVIG_CAM_PASSWORD}'
          posts: '<soap:Envelope xmlns:soap="http://www.w3.org/2003/05/soap-envelope" xmlns:tds="http://www.onvif.org/ver10/device/wsdl" xmlns:tt="http://www.onvif.org/ver10/schema"><soap:Body><tds:GetScopes /><tds:GetDeviceInformation /></soap:Body></soap:Envelope>'
          request_method: POST
          tags:
            - tag: Type
              value: ONVIF
          triggers:
            - uuid: 894908c06a4f42738dd16f954756d551
              expression: 'nodata(/BA - ONVIF - Avigilon/camera.scopes,60m)=1'
              name: 'Could not retrieve device parameters via ONVIF'
              priority: WARNING
              description: 'Please check the password on the device.'
              manual_close: 'YES'
              dependencies:
                - name: 'Device offline'
                  expression: 'last(/BA - Generic - ICMP/icmppingretry[{HOST.HOST},3])=0'
                - name: 'ICMP Loss >= {$ICMP_HIGH_LOSS_WARN}%'
                  expression: 'avg(/BA - Generic - ICMP/icmppingloss[{HOST.HOST},5,1000],#3)>={$ICMP_HIGH_LOSS_WARN}'
              tags:
                - tag: Type
                  value: ONVIF
        - uuid: 3eb186a618c14079a2f8d7bc6f5a3f3f
          name: 'Device Sensor'
          type: DEPENDENT
          key: camera.sensor
          history: 7d
          value_type: CHAR
          inventory_link: TYPE
          preprocessing:
            - type: JAVASCRIPT
              parameters:
                - |
                  var result = '';
                  var data = JSON.parse(value);
                  var source = data.Envelope.Body.GetVideoSourcesResponse.VideoSources;
                  if (data.Envelope.Body.GetVideoSourcesResponse.VideoSources[0] != undefined) { 
                      source = data.Envelope.Body.GetVideoSourcesResponse.VideoSources[0]; 
                  }
                  result += source.Resolution.Width;
                  result += 'x';
                  result += source.Resolution.Height;
                  return result;
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1d
          master_item:
            key: camera.media
          tags:
            - tag: Type
              value: Sensor
        - uuid: c469663ea4ea4ad69f8b05bfc4b6e2bb
          name: 'Device Serial'
          type: DEPENDENT
          key: camera.serial
          history: 7d
          value_type: CHAR
          inventory_link: SERIALNO_A
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.Envelope.Body.GetDeviceInformationResponse.SerialNumber
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1d
          master_item:
            key: camera.info
          tags:
            - tag: Type
              value: Serial
      tags:
        - tag: Type
          value: ONVIF
      dashboards:
        - uuid: 520e80c0f687421cb23e6c0f3df2ed13
          name: Avigilon
          pages:
            - widgets:
                - type: item
                  width: '36'
                  fields:
                    - type: INTEGER
                      name: decimal_size
                      value: '10'
                    - type: STRING
                      name: description
                      value: 'Avigilon Camera'
                    - type: INTEGER
                      name: desc_size
                      value: '30'
                    - type: INTEGER
                      name: desc_v_pos
                      value: '0'
                    - type: ITEM
                      name: itemid
                      value:
                        host: 'BA - ONVIF - Avigilon'
                        key: camera.name
                    - type: INTEGER
                      name: show
                      value: '1'
                    - type: INTEGER
                      name: show
                      value: '2'
                    - type: INTEGER
                      name: units_bold
                      value: '0'
                    - type: INTEGER
                      name: units_size
                      value: '10'
                    - type: INTEGER
                      name: value_size
                      value: '35'
                - type: item
                  'y': '2'
                  width: '12'
                  fields:
                    - type: INTEGER
                      name: decimal_size
                      value: '10'
                    - type: ITEM
                      name: itemid
                      value:
                        host: 'BA - ONVIF - Avigilon'
                        key: camera.net.mac
                    - type: INTEGER
                      name: show
                      value: '2'
                    - type: INTEGER
                      name: units_bold
                      value: '0'
                    - type: INTEGER
                      name: units_size
                      value: '10'
                    - type: INTEGER
                      name: value_bold
                      value: '0'
                    - type: INTEGER
                      name: value_size
                      value: '30'
                - type: item
                  'y': '4'
                  width: '12'
                  fields:
                    - type: INTEGER
                      name: decimal_size
                      value: '10'
                    - type: ITEM
                      name: itemid
                      value:
                        host: 'BA - ONVIF - Avigilon'
                        key: camera.sensor
                    - type: INTEGER
                      name: show
                      value: '2'
                    - type: INTEGER
                      name: units_bold
                      value: '0'
                    - type: INTEGER
                      name: units_size
                      value: '10'
                    - type: INTEGER
                      name: value_bold
                      value: '0'
                    - type: INTEGER
                      name: value_size
                      value: '30'
                - type: item
                  x: '12'
                  'y': '2'
                  width: '12'
                  fields:
                    - type: INTEGER
                      name: decimal_size
                      value: '10'
                    - type: ITEM
                      name: itemid
                      value:
                        host: 'BA - ONVIF - Avigilon'
                        key: camera.firmware.version
                    - type: INTEGER
                      name: show
                      value: '2'
                    - type: INTEGER
                      name: units_bold
                      value: '0'
                    - type: INTEGER
                      name: units_size
                      value: '10'
                    - type: INTEGER
                      name: value_bold
                      value: '0'
                    - type: INTEGER
                      name: value_size
                      value: '30'
                - type: item
                  x: '12'
                  'y': '4'
                  width: '12'
                  fields:
                    - type: INTEGER
                      name: decimal_size
                      value: '10'
                    - type: ITEM
                      name: itemid
                      value:
                        host: 'BA - ONVIF - Avigilon'
                        key: camera.serial
                    - type: INTEGER
                      name: show
                      value: '2'
                    - type: INTEGER
                      name: units_bold
                      value: '0'
                    - type: INTEGER
                      name: units_size
                      value: '10'
                    - type: INTEGER
                      name: value_bold
                      value: '0'
                    - type: INTEGER
                      name: value_size
                      value: '30'
                - type: item
                  x: '24'
                  'y': '2'
                  width: '12'
                  fields:
                    - type: INTEGER
                      name: decimal_size
                      value: '10'
                    - type: ITEM
                      name: itemid
                      value:
                        host: 'BA - ONVIF - Avigilon'
                        key: camera.model
                    - type: INTEGER
                      name: show
                      value: '2'
                    - type: INTEGER
                      name: units_bold
                      value: '0'
                    - type: INTEGER
                      name: units_size
                      value: '10'
                    - type: INTEGER
                      name: value_bold
                      value: '0'
                    - type: INTEGER
                      name: value_size
                      value: '30'

